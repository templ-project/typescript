name: Auto Retry Failed Jobs

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
  # workflow_dispatch: {}

jobs:
  retry:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Restore retry count
        id: cache
        uses: actions/cache/restore@v5
        with:
          key: retry-${{ github.event.workflow_run.id }}-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            retry-${{ github.event.workflow_run.id }}-
          path: .retry

      - name: Check retry count
        id: check
        run: |
          # Get retry count from cache
          retry_count=0
          if [[ -f .retry ]]; then
            retry_count=$(cat .retry)
          fi

          echo "Current retry count: ${retry_count}"
          retry_count=$((retry_count + 1))
          echo $retry_count > .retry
          max_retries=3

          echo "max_retries=${max_retries}" >> $GITHUB_OUTPUT
          echo "retry_count=${retry_count}" >> $GITHUB_OUTPUT

          # Only retry up to $max_retries times total
          if [ "${retry_count}" -le "${max_retries}" ]; then
            echo "Will retry (attempt ${retry_count}/${max_retries})"
            echo "should_retry=true" >> $GITHUB_OUTPUT
          else
            echo "Max retries reached (${retry_count}/3)"
            echo "should_retry=false" >> $GITHUB_OUTPUT
          fi

      - name: Save retry count
        if: always()
        uses: actions/cache/save@v5
        with:
          key: retry-${{ github.event.workflow_run.id }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: .retry

      - name: Wait before retry
        if: steps.check.outputs.should_retry == 'true'
        run: |
          echo "Waiting 30 seconds before retrying..."
          sleep 30

      - name: Retry failed jobs
        if: steps.check.outputs.should_retry == 'true'
        run: |
          RUN_ID="${{ github.event.workflow_run.id }}"

          echo "Triggering retry for run ${RUN_ID}..."

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/rerun-failed-jobs"

          retry_count=${{ steps.check.outputs.retry_count }}
          max_retries=${{ steps.check.outputs.max_retries }}
          echo "::notice::✓ Retry triggered successfully (attempt ${retry_count}/${max_retries})"

      - name: Skip retry
        if: steps.check.outputs.should_retry == 'false'
        run: |
          echo "::error::⚠️ Max retry attempts reached. Manual intervention required."
          echo "::error::View the failed run at: ${{ github.event.workflow_run.html_url }}"
          exit 1
